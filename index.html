<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PipeFlow — Boru Akış Simülatörü</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg:       #0a0d12;
    --surface:  #111520;
    --surface2: #161c2a;
    --border:   #1e2a3a;
    --accent:   #00e5ff;
    --accent2:  #ff6b35;
    --accent3:  #39ff14;
    --text:     #c8d8e8;
    --text-dim: #5a7080;
    --danger:   #ff3860;
    --warn:     #ffdd57;
    --success:  #23d160;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background:var(--bg); color:var(--text);
    font-family:'Rajdhani',sans-serif; font-size:15px;
    min-height:100vh;
  }
  body::before {
    content:''; position:fixed; inset:0;
    background-image:
      linear-gradient(rgba(0,229,255,0.025) 1px,transparent 1px),
      linear-gradient(90deg,rgba(0,229,255,0.025) 1px,transparent 1px);
    background-size:40px 40px; pointer-events:none; z-index:0;
  }
  .app { position:relative; z-index:1; max-width:1140px; margin:0 auto; padding:24px 16px; }

  /* ── Header ── */
  header { display:flex; align-items:center; gap:16px; border-bottom:1px solid var(--border); padding-bottom:16px; margin-bottom:28px; }
  .logo { width:44px; height:44px; border:2px solid var(--accent); display:flex; align-items:center; justify-content:center; font-family:'Space Mono',monospace; font-size:11px; color:var(--accent); letter-spacing:1px; position:relative; }
  .logo::before { content:''; position:absolute; inset:-5px; border:1px solid rgba(0,229,255,0.15); }
  .header-text h1 { font-size:24px; font-weight:700; letter-spacing:4px; text-transform:uppercase; color:#fff; }
  .header-text p { font-size:11px; color:var(--text-dim); letter-spacing:2px; text-transform:uppercase; font-family:'Space Mono',monospace; }
  .badge { margin-left:auto; padding:4px 12px; border:1px solid var(--accent3); color:var(--accent3); font-family:'Space Mono',monospace; font-size:10px; letter-spacing:2px; animation:pulse 2s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:.4} }

  /* ── Panels ── */
  .panel { background:var(--surface); border:1px solid var(--border); padding:20px; position:relative; margin-bottom:20px; }
  .panel::before { content:''; position:absolute; top:0; left:0; width:40px; height:2px; background:var(--accent); }
  .panel-title { font-size:11px; font-family:'Space Mono',monospace; color:var(--accent); letter-spacing:3px; text-transform:uppercase; margin-bottom:18px; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  @media(max-width:680px){ .grid2{ grid-template-columns:1fr; } }

  /* ── Form ── */
  .field { margin-bottom:14px; }
  .field label { display:block; font-size:11px; color:var(--text-dim); letter-spacing:2px; text-transform:uppercase; margin-bottom:5px; font-family:'Space Mono',monospace; }
  .field input, .field select { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:8px 12px; font-family:'Rajdhani',sans-serif; font-size:15px; font-weight:500; outline:none; transition:border-color .2s; appearance:none; }
  .field input:focus, .field select:focus { border-color:var(--accent); box-shadow:0 0 0 1px rgba(0,229,255,.15); }
  .field select option { background:#1a2030; }
  .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  @media(max-width:500px){ .row2,.row3{ grid-template-columns:1fr; } }

  /* ── Fluid props display ── */
  .props-strip { display:flex; gap:20px; flex-wrap:wrap; padding:10px 14px; background:var(--bg); border:1px solid var(--border); margin-top:4px; }
  .prop-item span.lbl { font-family:'Space Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:1px; }
  .prop-item span.val { font-family:'Space Mono',monospace; font-size:13px; color:var(--accent); margin:0 2px; }
  .prop-item span.unit { font-size:10px; color:var(--text-dim); }

  /* ── Segments ── */
  .seg-list { display:flex; flex-direction:column; gap:12px; }
  .seg-item { background:var(--surface2); border:1px solid var(--border); border-left:3px solid var(--accent2); padding:14px; animation:slideIn .25s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
  .seg-head { display:flex; align-items:center; gap:8px; margin-bottom:12px; }
  .seg-num { width:24px; height:24px; background:var(--accent2); color:#000; display:flex; align-items:center; justify-content:center; font-family:'Space Mono',monospace; font-size:10px; font-weight:700; flex-shrink:0; }
  .seg-lbl { font-size:12px; color:var(--text-dim); font-family:'Space Mono',monospace; letter-spacing:1px; flex:1; }
  .btn-rm { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:16px; padding:2px 6px; transition:color .2s; }
  .btn-rm:hover { color:var(--danger); }
  .fittings-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:10px; }
  @media(max-width:500px){ .fittings-grid{ grid-template-columns:1fr 1fr; } }
  .fit-item { display:flex; align-items:center; gap:6px; background:var(--bg); border:1px solid var(--border); padding:6px 8px; }
  .fit-item label { font-size:10px; color:var(--text-dim); font-family:'Space Mono',monospace; flex:1; margin:0; line-height:1.3; }
  .fit-item input { width:44px; background:transparent; border:none; border-bottom:1px solid var(--border); color:var(--text); font-family:'Rajdhani',monospace; font-size:14px; padding:2px 4px; text-align:center; outline:none; }

  /* ── Buttons ── */
  .btn { display:inline-flex; align-items:center; gap:8px; padding:9px 18px; font-family:'Rajdhani',sans-serif; font-size:14px; font-weight:700; letter-spacing:2px; text-transform:uppercase; cursor:pointer; border:none; outline:none; transition:all .2s; }
  .btn-primary { background:var(--accent); color:#000; }
  .btn-primary:hover { background:#33eeff; box-shadow:0 0 20px rgba(0,229,255,.35); }
  .btn-ghost { background:transparent; border:1px solid var(--accent2); color:var(--accent2); }
  .btn-ghost:hover { background:rgba(255,107,53,.1); }
  .btn-secondary { background:transparent; border:1px solid var(--border); color:var(--text-dim); }
  .btn-secondary:hover { border-color:var(--text-dim); color:var(--text); }
  .btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

  /* ── Divider ── */
  .div-label { display:flex; align-items:center; gap:8px; margin:12px 0 8px; }
  .div-label span { font-family:'Space Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:2px; white-space:nowrap; text-transform:uppercase; }
  .div-label::before,.div-label::after { content:''; flex:1; height:1px; background:var(--border); }

  /* ── Error ── */
  .error-box { background:rgba(255,56,96,.1); border:1px solid var(--danger); color:var(--danger); padding:12px 16px; font-family:'Space Mono',monospace; font-size:12px; margin-bottom:16px; display:none; }
  .error-box.show { display:block; }

  /* ── Results ── */
  #results { display:none; }
  #results.show { display:block; }
  .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
  @media(max-width:700px){ .kpi-grid{ grid-template-columns:1fr 1fr; } }
  .kpi { background:var(--surface2); border:1px solid var(--border); padding:14px; position:relative; overflow:hidden; }
  .kpi::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--accent); }
  .kpi.warn::after { background:var(--warn); }
  .kpi.danger::after { background:var(--danger); }
  .kpi.green::after { background:var(--accent3); }
  .kpi-lbl { font-family:'Space Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:2px; text-transform:uppercase; margin-bottom:6px; }
  .kpi-val { font-family:'Space Mono',monospace; font-size:22px; font-weight:700; color:#fff; line-height:1; }
  .kpi-unit { font-size:11px; color:var(--text-dim); margin-top:3px; }
  .status-badge { padding:4px 14px; font-family:'Space Mono',monospace; font-size:11px; letter-spacing:2px; text-transform:uppercase; font-weight:700; }
  .s-ok    { background:rgba(35,209,96,.12); border:1px solid var(--success); color:var(--success); }
  .s-warn  { background:rgba(255,221,87,.12); border:1px solid var(--warn);    color:var(--warn);    }
  .s-error { background:rgba(255,56,96,.12);  border:1px solid var(--danger);  color:var(--danger);  }

  /* ── Loss bars ── */
  .loss-row { margin-bottom:10px; }
  .loss-meta { display:flex; justify-content:space-between; font-size:11px; margin-bottom:3px; }
  .loss-meta .lname { font-family:'Space Mono',monospace; font-size:10px; color:var(--text-dim); }
  .loss-meta .lval  { font-family:'Space Mono',monospace; font-size:10px; }
  .bar-track { height:6px; background:var(--bg); border:1px solid var(--border); }
  .bar-fill  { height:100%; transition:width .6s ease; }

  /* ── Table ── */
  .tbl-wrap { overflow-x:auto; }
  table { width:100%; border-collapse:collapse; }
  th { text-align:left; padding:8px 10px; font-family:'Space Mono',monospace; font-size:9px; letter-spacing:2px; color:var(--text-dim); text-transform:uppercase; border-bottom:1px solid var(--border); background:var(--bg); white-space:nowrap; }
  td { padding:8px 10px; font-size:14px; border-bottom:1px solid rgba(30,42,58,.5); white-space:nowrap; }
  tr:hover td { background:rgba(0,229,255,.025); }
  .mono { font-family:'Space Mono',monospace; font-size:11px; }
  .c-L  { color:var(--accent); }
  .c-Tr { color:var(--warn); }
  .c-T  { color:var(--accent2); }
  .c-warn { color:var(--warn); }
  .c-ok   { color:var(--accent2); }

  /* ── Charts ── */
  .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  @media(max-width:680px){ .charts-grid{ grid-template-columns:1fr; } }
  .chart-wrap { background:var(--surface2); border:1px solid var(--border); padding:14px; }
  .chart-title { font-family:'Space Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:2px; text-transform:uppercase; margin-bottom:12px; }

  /* ── SVG Diagram ── */
  .diagram-wrap { overflow-x:auto; padding:8px 0; }

  .tag { display:inline-block; padding:2px 8px; font-family:'Space Mono',monospace; font-size:9px; letter-spacing:1px; background:rgba(0,229,255,.08); border:1px solid rgba(0,229,255,.2); color:var(--accent); margin-left:8px; vertical-align:middle; }
</style>
</head>
<body>
<div class="app">

<!-- Header -->
<header>
  <div class="logo">ΔP</div>
  <div class="header-text">
    <h1>PipeFlow</h1>
    <p>Boru Akış Simülatörü v2.0</p>
  </div>
  <div class="badge">● ENGINE HAZIR</div>
</header>

<!-- ── GİRİŞ FORMU ── -->
<div class="grid2">

  <!-- Sol: Sıvı & Ortam -->
  <div>
    <div class="panel">
      <div class="panel-title">Sıvı & Ortam <span class="tag">Su (H₂O)</span></div>
      <div class="row2">
        <div class="field">
          <label>Sıcaklık (°C)</label>
          <input type="number" id="inp_T" value="20" min="0" max="200" oninput="onInputChange()">
        </div>
        <div class="field">
          <label>Giriş Basıncı (bar)</label>
          <input type="number" id="inp_P" value="2.0" min="0" step="0.1" oninput="onInputChange()">
        </div>
      </div>
      <div class="field">
        <label>Giriş Debisi (L/min)</label>
        <input type="number" id="inp_Q" value="50" min="0.001" step="1" oninput="onInputChange()">
      </div>
      <div class="field">
        <label>Yüzey Pürüzlülüğü</label>
        <select id="inp_rough" onchange="onRoughChange()">
          <option value="0.0015">Çelik (yeni) — ε=0.0015 mm</option>
          <option value="0.046" selected>Çelik (eski) — ε=0.046 mm</option>
          <option value="0.26">Dökme demir — ε=0.26 mm</option>
          <option value="0.003">PVC/PE — ε=0.003 mm</option>
          <option value="0.0015b">Bakır/Pirinç — ε=0.0015 mm</option>
          <option value="custom">Özel giriş...</option>
        </select>
      </div>
      <div class="field" id="customRoughField" style="display:none">
        <label>Özel ε (mm)</label>
        <input type="number" id="inp_rough_custom" value="0.046" step="0.001" min="0">
      </div>

      <div class="div-label"><span>Sıvı Özellikleri @ T°C</span></div>
      <div class="props-strip" id="propsStrip">
        <div class="prop-item"><span class="lbl">ρ =</span><span class="val" id="dp_rho">—</span><span class="unit">kg/m³</span></div>
        <div class="prop-item"><span class="lbl">μ =</span><span class="val" id="dp_mu">—</span><span class="unit">mPa·s</span></div>
        <div class="prop-item"><span class="lbl">ν =</span><span class="val" id="dp_nu">—</span><span class="unit">mm²/s</span></div>
        <div class="prop-item"><span class="lbl">Pr =</span><span class="val" id="dp_Pr">—</span><span class="unit">—</span></div>
      </div>
    </div>
  </div>

  <!-- Sağ: μ(T) grafiği -->
  <div>
    <div class="panel" style="height:100%">
      <div class="panel-title">Viskozite & Yoğunluk — T Eğrisi</div>
      <canvas id="chartFluid" height="180"></canvas>
    </div>
  </div>

</div>

<!-- ── SEGMENTLER ── -->
<div class="panel">
  <div class="panel-title">Boru Segmentleri <span class="tag">SERİ</span></div>
  <div class="seg-list" id="segList"></div>
  <div class="btn-row">
    <button class="btn btn-ghost" onclick="addSegment()">+ Segment Ekle</button>
    <button class="btn btn-secondary" onclick="resetSegments()">↺ Sıfırla</button>
  </div>
</div>

<!-- Error -->
<div class="error-box" id="errBox"></div>

<!-- Hesapla -->
<div style="margin-bottom:28px">
  <button class="btn btn-primary" style="width:100%;justify-content:center;padding:14px;font-size:16px;letter-spacing:3px" onclick="runCalc()">
    ⟶ HESAPLA
  </button>
</div>

<!-- ── SONUÇLAR ── -->
<div id="results">

  <!-- KPI + Status -->
  <div class="panel">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;flex-wrap:wrap">
      <div class="panel-title" style="margin:0">Sonuçlar</div>
      <div id="statusBadge" class="status-badge">—</div>
      <div id="regimeTag" style="margin-left:auto;font-family:'Space Mono',monospace;font-size:10px;color:var(--text-dim)"></div>
    </div>
    <div class="kpi-grid" id="kpiGrid"></div>
    <div class="div-label"><span>Yük Kaybı Dağılımı</span></div>
    <div id="lossBreakdown"></div>
  </div>

  <!-- Akış diyagramı -->
  <div class="panel">
    <div class="panel-title">Akış Diyagramı</div>
    <div class="diagram-wrap" id="diagram"></div>
  </div>

  <!-- Segment tablosu -->
  <div class="panel">
    <div class="panel-title">Segment Analizi</div>
    <div class="tbl-wrap" id="segTable"></div>
  </div>

  <!-- Grafikler -->
  <div class="panel">
    <div class="panel-title">Basınç & Yük Profili</div>
    <div class="charts-grid">
      <div class="chart-wrap">
        <div class="chart-title">Segment Bazlı Basınç (bar)</div>
        <canvas id="chartP"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-title">Kayıp Bileşenleri (m)</div>
        <canvas id="chartLoss"></canvas>
      </div>
    </div>
  </div>

</div><!-- /results -->

</div><!-- /app -->

<!-- ═════════════════════════ INLINE MODULES ═════════════════════════ -->
<script type="module">

// ─────────────────────────────────────────────────────────────────────
// 1. WATER DATA  (data/water.js — inline for single-file compatibility)
// ─────────────────────────────────────────────────────────────────────
const waterData = {
  meta: {
    id: 'water', name: 'Su (H₂O)', formula: 'H₂O',
    source: 'NIST WebBook — Saturated Liquid, 1 atm',
    version: '1.0.0',
    tempRange: { min: 0, max: 200, unit: 'C' },
  },
  props: [
    //  T      rho       mu       nu       cp       λ       Pr
    [   0,  999.84,  1.7916,  1.7919,  4218.0,  0.5610,  13.47 ],
    [   5,  999.97,  1.5188,  1.5188,  4202.0,  0.5740,  11.16 ],
    [  10,  999.70,  1.3077,  1.3081,  4192.0,  0.5800,   9.45 ],
    [  15,  999.10,  1.1382,  1.1393,  4186.0,  0.5890,   8.09 ],
    [  20,  998.21,  1.0016,  1.0034,  4182.0,  0.5984,   7.01 ],
    [  25,  997.05,  0.8900,  0.8927,  4180.0,  0.6069,   6.13 ],
    [  30,  995.65,  0.7972,  0.8007,  4178.0,  0.6155,   5.42 ],
    [  35,  994.03,  0.7191,  0.7233,  4178.0,  0.6234,   4.83 ],
    [  40,  992.22,  0.6527,  0.6578,  4179.0,  0.6310,   4.32 ],
    [  45,  990.22,  0.5958,  0.6017,  4181.0,  0.6378,   3.91 ],
    [  50,  988.07,  0.5465,  0.5530,  4181.0,  0.6444,   3.55 ],
    [  55,  985.73,  0.5040,  0.5113,  4183.0,  0.6507,   3.25 ],
    [  60,  983.20,  0.4666,  0.4746,  4185.0,  0.6562,   2.98 ],
    [  65,  980.55,  0.4340,  0.4426,  4187.0,  0.6614,   2.75 ],
    [  70,  977.76,  0.4048,  0.4141,  4190.0,  0.6659,   2.55 ],
    [  75,  974.84,  0.3790,  0.3888,  4193.0,  0.6700,   2.37 ],
    [  80,  971.82,  0.3559,  0.3662,  4196.0,  0.6737,   2.22 ],
    [  85,  968.65,  0.3350,  0.3459,  4200.0,  0.6771,   2.08 ],
    [  90,  965.34,  0.3160,  0.3273,  4205.0,  0.6800,   1.96 ],
    [  95,  961.92,  0.2986,  0.3104,  4209.0,  0.6825,   1.85 ],
    [ 100,  958.37,  0.2821,  0.2944,  4216.0,  0.6844,   1.75 ],
    [ 105,  954.74,  0.2677,  0.2805,  4222.0,  0.6860,   1.65 ],
    [ 110,  950.95,  0.2538,  0.2669,  4229.0,  0.6870,   1.56 ],
    [ 115,  947.13,  0.2414,  0.2549,  4236.0,  0.6877,   1.49 ],
    [ 120,  943.11,  0.2296,  0.2434,  4245.0,  0.6880,   1.41 ],
    [ 125,  939.02,  0.2187,  0.2329,  4254.0,  0.6878,   1.35 ],
    [ 130,  934.83,  0.2085,  0.2230,  4263.0,  0.6872,   1.29 ],
    [ 140,  926.13,  0.1897,  0.2049,  4285.0,  0.6853,   1.18 ],
    [ 150,  916.98,  0.1737,  0.1894,  4310.0,  0.6824,   1.10 ],
    [ 160,  907.45,  0.1597,  0.1760,  4340.0,  0.6790,   1.02 ],
    [ 170,  897.45,  0.1470,  0.1638,  4370.0,  0.6741,   0.95 ],
    [ 180,  886.98,  0.1357,  0.1530,  4410.0,  0.6682,   0.90 ],
    [ 190,  876.06,  0.1255,  0.1433,  4460.0,  0.6615,   0.85 ],
    [ 200,  864.66,  0.1164,  0.1347,  4500.0,  0.6537,   0.80 ],
  ],
  columns: { T_C:0, rho:1, mu:2, nu:3, cp:4, lambda:5, Pr:6 },
};

// ─────────────────────────────────────────────────────────────────────
// 2. FITTINGS LIB
// ─────────────────────────────────────────────────────────────────────
const fittingsLib = {
  elbow90:     { id:'elbow90',     label:'90° Dirsek',            K:0.75 },
  elbow90_long:{ id:'elbow90_long',label:'90° Uzun Yarıçap',      K:0.45 },
  elbow45:     { id:'elbow45',     label:'45° Dirsek',            K:0.35 },
  elbow180:    { id:'elbow180',    label:'180° U Dönüş',          K:1.50 },
  gate_full:   { id:'gate_full',   label:'Sürgülü Vana',          K:0.20 },
  ball_full:   { id:'ball_full',   label:'Ball Vana',             K:0.10 },
  globe:       { id:'globe',       label:'Küresel Vana',          K:6.00 },
  butterfly:   { id:'butterfly',   label:'Kelebek Vana',          K:0.30 },
  check_swing: { id:'check_swing', label:'Çek Valf (sallanır)',   K:2.50 },
  check_ball:  { id:'check_ball',  label:'Çek Valf (bilyeli)',    K:3.00 },
  tee_through: { id:'tee_through', label:'T (düz geçiş)',         K:0.40 },
  tee_branch:  { id:'tee_branch',  label:'T (dal akışı)',         K:1.00 },
  entrance_sharp:   { id:'entrance_sharp',   label:'Keskin Giriş',   K:0.50 },
  entrance_rounded: { id:'entrance_rounded', label:'Yuvarlak Giriş', K:0.10 },
  exit:        { id:'exit',        label:'Serbest Çıkış',         K:1.00 },
  strainer_y:  { id:'strainer_y',  label:'Y Filtre',              K:0.80 },
};

const DEFAULT_FITTINGS = ['elbow90','elbow45','gate_full','globe','ball_full','check_swing'];

// ─────────────────────────────────────────────────────────────────────
// 3. INTERPOLATION ENGINE  (engine/interpolate.js — inline)
// ─────────────────────────────────────────────────────────────────────
function bisect(xs, x) {
  let lo=0, hi=xs.length-1;
  if(x<=xs[lo]) return 0;
  if(x>=xs[hi]) return hi-1;
  while(hi-lo>1){ const m=(lo+hi)>>1; if(xs[m]<=x) lo=m; else hi=m; }
  return lo;
}
function lerp(x0,x1,y0,y1,x){ return y0+(y1-y0)*(x-x0)/(x1-x0||1); }

function buildCubicSpline(xs,ys){
  const n=xs.length, h=[], alpha=[];
  for(let i=0;i<n-1;i++) h[i]=xs[i+1]-xs[i];
  for(let i=1;i<n-1;i++) alpha[i]=(3/h[i])*(ys[i+1]-ys[i])-(3/h[i-1])*(ys[i]-ys[i-1]);
  const l=new Array(n).fill(1), mu=new Array(n).fill(0), z=new Array(n).fill(0);
  const c=new Array(n).fill(0), b=new Array(n-1), d=new Array(n-1);
  for(let i=1;i<n-1;i++){
    l[i]=2*(xs[i+1]-xs[i-1])-h[i-1]*mu[i-1];
    mu[i]=h[i]/l[i]; z[i]=(alpha[i]-h[i-1]*z[i-1])/l[i];
  }
  for(let j=n-2;j>=0;j--){
    c[j]=z[j]-mu[j]*c[j+1];
    b[j]=(ys[j+1]-ys[j])/h[j]-h[j]*(c[j+1]+2*c[j])/3;
    d[j]=(c[j+1]-c[j])/(3*h[j]);
  }
  return {xs,ys,b,c,d};
}
function evalSpline(sp,x){
  const i=bisect(sp.xs,x), dx=x-sp.xs[i];
  return sp.ys[i]+sp.b[i]*dx+sp.c[i]*dx*dx+sp.d[i]*dx*dx*dx;
}

function lookupProp(fluid, prop, T){
  const ci=fluid.columns[prop];
  const T_=Math.max(fluid.meta.tempRange.min, Math.min(fluid.meta.tempRange.max, T));
  const xs=fluid.props.map(r=>r[0]);
  const ys=fluid.props.map(r=>r[ci]);
  const i=bisect(xs,T_);
  return lerp(xs[i],xs[i+1],ys[i],ys[i+1],T_);
}

function getAllProps(fluid, T){
  const res={T_C:T};
  for(const [k,ci] of Object.entries(fluid.columns)){
    if(k==='T_C') continue;
    res[k]=lookupProp(fluid,k,T);
  }
  return res;
}

function getPropsRange(fluid, T0, T1, n=60){
  const out=[]; const step=(T1-T0)/(n-1);
  for(let i=0;i<n;i++) out.push(getAllProps(fluid, T0+i*step));
  return out;
}

// ─────────────────────────────────────────────────────────────────────
// 4. HYDRAULICS ENGINE  (engine/hydraulics.js — inline)
// ─────────────────────────────────────────────────────────────────────
const G = 9.80665;

function Re(v,D,nu_m2s){ return v*D/nu_m2s; }

function flowRegime(re){
  if(re<2300) return {regime:'Laminer',  code:'L',  color:'#00e5ff'};
  if(re<4000) return {regime:'Geçiş',   code:'Tr', color:'#ffdd57'};
  return            {regime:'Türb.',    code:'T',  color:'#ff6b35'};
}

function frictionFactor(re, D, eps_mm){
  if(re<1e-9) return 64;
  const eps=(eps_mm/1000)/D;
  if(re<=2300) return 64/re;
  const f_t=_colebrook(re,eps);
  if(re<4000){
    const t=(re-2300)/1700;
    return (64/2300)*(1-t)+f_t*t;
  }
  return f_t;
}
function _colebrook(re,eps){
  let f=0.25/Math.pow(Math.log10(eps/3.7+5.74/Math.pow(re,0.9)),2);
  for(let i=0;i<50;i++){
    const rhs=-2*Math.log10(eps/3.7+2.51/(re*Math.sqrt(f)));
    const fn=1/(rhs*rhs);
    if(Math.abs(fn-f)<1e-12) break;
    f=fn;
  }
  return f;
}

function calcSegment(seg, Q_m3s, rho, mu_mPas, eps_mm, prevSeg){
  const D=seg.diameter/1000;
  const A=Math.PI*D*D/4;
  const v=Q_m3s/A;
  const nu=(mu_mPas/1000)/rho;
  const re=Re(v,D,nu);
  const reg=flowRegime(re);
  const f=frictionFactor(re,D,eps_mm);

  const hf_fr = f*(seg.length/D)*(v*v)/(2*G);

  let K_total=0;
  const fitDetail={};
  for(const [key,cnt] of Object.entries(seg.fittings||{})){
    if(!cnt||cnt<=0) continue;
    const K=fittingsLib[key]?.K??0;
    K_total+=K*cnt;
    fitDetail[key]={cnt,K,loss:K*cnt*v*v/(2*G)};
  }
  const hf_fit=K_total*v*v/(2*G);
  const hf_elev=seg.dz;

  let hf_trans=0, transType=null;
  if(prevSeg){
    const D0=prevSeg.diameter/1000;
    if(Math.abs(D-D0)>1e-4){
      if(D<D0){
        const A0=Math.PI*D0*D0/4, aR=A/A0, Kc=0.5*(1-aR);
        hf_trans=Kc*v*v/(2*G); transType='daralma';
      } else {
        const A0=Math.PI*D0*D0/4, v0=Q_m3s/A0, dv=v0-v;
        hf_trans=dv*dv/(2*G); transType='genişleme';
      }
    }
  }

  const hf_total=hf_fr+hf_fit+hf_elev+hf_trans;
  const dP_Pa=rho*G*hf_total;

  return {
    diameter_mm:seg.diameter, length_m:seg.length, dz_m:seg.dz,
    v, Re:re, regime:reg, f,
    hf:{ friction:hf_fr, fittings:hf_fit, elevation:hf_elev, transition:hf_trans, total:hf_total },
    transType, fitDetail, K_total,
    dP_Pa, dP_bar:dP_Pa/1e5,
  };
}

function calcSystem(segments, Q_lpm, P_in_bar, T, eps_mm){
  const fp=getAllProps(waterData, T);
  const Q_m3s=Q_lpm/60000;

  const segRes=segments.map((s,i)=>
    calcSegment(s, Q_m3s, fp.rho, fp.mu, eps_mm, i>0?segments[i-1]:null)
  );

  const tot=segRes.reduce((a,s)=>({
    fr:   a.fr+s.hf.friction,
    fit:  a.fit+s.hf.fittings,
    elev: a.elev+s.hf.elevation,
    trans:a.trans+s.hf.transition,
    total:a.total+s.hf.total,
    dP:   a.dP+s.dP_Pa,
  }),{fr:0,fit:0,elev:0,trans:0,total:0,dP:0});

  const P_out_bar=P_in_bar-tot.dP/1e5;
  const reMax=Math.max(...segRes.map(s=>s.Re));
  const reMin=Math.min(...segRes.map(s=>s.Re));

  let status;
  if(P_out_bar<0)   status={code:'error',label:'BASINÇ YETERSİZ', cls:'s-error'};
  else if(P_out_bar<0.3) status={code:'warn', label:'DÜŞÜK BASINÇ',   cls:'s-warn'};
  else              status={code:'ok',   label:'NORMAL',           cls:'s-ok'};

  let overallRegime;
  if(reMax<2300)      overallRegime={regime:'Tüm Sistem Laminer', code:'L'};
  else if(reMin<4000) overallRegime={regime:'Geçiş Bölgesi Var',  code:'Tr'};
  else                overallRegime={regime:'Tüm Sistem Türb.',   code:'T'};

  return { Q_lpm, Q_b:Q_lpm, P_in_bar, P_out_bar, fluid:fp, tot, segments:segRes, status, overallRegime };
}

// ─────────────────────────────────────────────────────────────────────
// 5. UI STATE
// ─────────────────────────────────────────────────────────────────────
let segments_ui = [];
let segIdCnt = 0;
let chartFluid = null, chartP = null, chartLoss = null;

function getRoughness(){
  const v=document.getElementById('inp_rough').value;
  if(v==='custom') return parseFloat(document.getElementById('inp_rough_custom').value)||0.046;
  return parseFloat(v)||0.046;
}

// ─────────────────────────────────────────────────────────────────────
// 6. SEGMENT MANAGEMENT
// ─────────────────────────────────────────────────────────────────────
function addSegment(preset){
  const id=++segIdCnt;
  const seg=Object.assign({
    id, length:5, diameter:50, dz:0,
    fittings:{ elbow90:0, elbow45:0, gate_full:0, globe:0, ball_full:0, check_swing:0 }
  }, preset||{}, {id});
  segments_ui.push(seg);
  renderSegments();
}

function removeSegment(id){
  segments_ui=segments_ui.filter(s=>s.id!==id);
  renderSegments();
}

function readSegments(){
  segments_ui.forEach(seg=>{
    const g=k=>document.getElementById(k+'_'+seg.id);
    seg.length  = parseFloat(g('L').value)||1;
    seg.diameter= parseFloat(g('D').value)||50;
    seg.dz      = parseFloat(g('dz').value)||0;
    DEFAULT_FITTINGS.forEach(fk=>{
      const el=document.getElementById('fit_'+fk+'_'+seg.id);
      seg.fittings[fk]=el?(parseInt(el.value)||0):0;
    });
  });
}

function resetSegments(){
  segments_ui=[]; segIdCnt=0;
  addSegment({length:10, diameter:50, dz:0, fittings:{elbow90:2,elbow45:0,gate_full:1,globe:0,ball_full:0,check_swing:0}});
}

function renderSegments(){
  const c=document.getElementById('segList');
  c.innerHTML='';
  segments_ui.forEach((seg,idx)=>{
    const d=document.createElement('div');
    d.className='seg-item';
    d.innerHTML=`
      <div class="seg-head">
        <div class="seg-num">${idx+1}</div>
        <div class="seg-lbl">SEG ${idx+1} — ${idx===0?'Giriş (A)':'↳'} → ${idx===segments_ui.length-1?'Çıkış (B)':'Sonraki'}</div>
        ${segments_ui.length>1?`<button class="btn-rm" onclick="removeSegment(${seg.id})">✕</button>`:''}
      </div>
      <div class="row3">
        <div class="field"><label>Uzunluk (m)</label><input type="number" id="L_${seg.id}" value="${seg.length}" min="0.01" step="0.5"></div>
        <div class="field"><label>Çap (mm)</label><input type="number" id="D_${seg.id}" value="${seg.diameter}" min="1" step="1"></div>
        <div class="field"><label>Δz (m)</label><input type="number" id="dz_${seg.id}" value="${seg.dz}" step="0.1"></div>
      </div>
      <div class="div-label"><span>Bağlantı Elemanları</span></div>
      <div class="fittings-grid">
        ${DEFAULT_FITTINGS.map(fk=>{
          const fd=fittingsLib[fk];
          return `<div class="fit-item">
            <label>${fd.label}<br><span style="color:var(--accent);font-size:9px">K=${fd.K}</span></label>
            <input type="number" id="fit_${fk}_${seg.id}" value="${seg.fittings[fk]||0}" min="0" step="1">
          </div>`;
        }).join('')}
      </div>
    `;
    c.appendChild(d);
  });
}

// ─────────────────────────────────────────────────────────────────────
// 7. FLUID CHART (μ & ρ vs T)
// ─────────────────────────────────────────────────────────────────────
function initFluidChart(){
  const range=getPropsRange(waterData,0,200,50);
  const Ts=range.map(r=>r.T_C);
  const mus=range.map(r=>r.mu);
  const rhos=range.map(r=>r.rho);
  const T_cur=parseFloat(document.getElementById('inp_T').value)||20;

  const ctx=document.getElementById('chartFluid');
  if(chartFluid) chartFluid.destroy();
  chartFluid=new Chart(ctx,{
    type:'line',
    data:{
      labels:Ts,
      datasets:[
        {
          label:'μ (mPa·s)',
          data:mus,
          borderColor:'#00e5ff',
          backgroundColor:'rgba(0,229,255,0.06)',
          yAxisID:'y',
          tension:0.4, pointRadius:0, borderWidth:2,
        },
        {
          label:'ρ (kg/m³) ÷ 10',
          data:rhos.map(r=>r/10),
          borderColor:'#ff6b35',
          backgroundColor:'rgba(255,107,53,0.06)',
          yAxisID:'y',
          tension:0.3, pointRadius:0, borderWidth:1.5, borderDash:[4,3],
        },
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:true,
      plugins:{ legend:{ labels:{ color:'#5a7080', font:{family:'Space Mono',size:10} } } },
      scales:{
        x:{
          ticks:{ color:'#5a7080', font:{family:'Space Mono',size:9}, maxTicksLimit:10 },
          grid:{ color:'rgba(30,42,58,0.8)' },
          title:{ display:true, text:'T (°C)', color:'#5a7080', font:{size:10} },
        },
        y:{
          ticks:{ color:'#5a7080', font:{family:'Space Mono',size:9} },
          grid:{ color:'rgba(30,42,58,0.8)' },
        }
      },
      annotation:{
        annotations:{
          line1:{ type:'line', xMin:T_cur, xMax:T_cur, borderColor:'rgba(255,255,255,0.3)', borderWidth:1, borderDash:[3,3] }
        }
      }
    }
  });
}

// ─────────────────────────────────────────────────────────────────────
// 8. PROPS STRIP UPDATE
// ─────────────────────────────────────────────────────────────────────
function onInputChange(){
  const T=parseFloat(document.getElementById('inp_T').value)||20;
  const fp=getAllProps(waterData,T);
  document.getElementById('dp_rho').textContent=fp.rho.toFixed(2);
  document.getElementById('dp_mu').textContent=fp.mu.toFixed(4);
  document.getElementById('dp_nu').textContent=fp.nu.toFixed(4);
  document.getElementById('dp_Pr').textContent=fp.Pr.toFixed(2);
}

function onRoughChange(){
  document.getElementById('customRoughField').style.display=
    document.getElementById('inp_rough').value==='custom'?'block':'none';
}

// ─────────────────────────────────────────────────────────────────────
// 9. MAIN CALCULATION + RENDER
// ─────────────────────────────────────────────────────────────────────
function runCalc(){
  readSegments();
  const Q=parseFloat(document.getElementById('inp_Q').value);
  const P=parseFloat(document.getElementById('inp_P').value);
  const T=parseFloat(document.getElementById('inp_T').value)||20;
  const eps=getRoughness();
  const errBox=document.getElementById('errBox');
  errBox.className='error-box';

  if(!Q||Q<=0) return showErr('Giriş debisi pozitif olmalı.');
  if(!P&&P!==0) return showErr('Giriş basıncı girilmeli.');
  if(segments_ui.length===0) return showErr('En az bir segment tanımlayın.');
  for(const s of segments_ui){
    if(s.diameter<=0) return showErr(`Segment çapı > 0 olmalı.`);
    if(s.length<=0)   return showErr(`Segment uzunluğu > 0 olmalı.`);
  }

  const res=calcSystem(segments_ui, Q, P, T, eps);
  renderResults(res);
}

function showErr(msg){
  const e=document.getElementById('errBox');
  e.textContent='⚠ '+msg; e.className='error-box show';
  e.scrollIntoView({behavior:'smooth'});
}

function renderResults(r){
  const el=id=>document.getElementById(id);

  el('results').classList.add('show');
  el('errBox').className='error-box';

  // Status
  el('statusBadge').textContent=r.status.label;
  el('statusBadge').className='status-badge '+r.status.cls;
  el('regimeTag').textContent=r.overallRegime.regime;
  el('regimeTag').className='mono c-'+r.overallRegime.code;

  // KPIs
  el('kpiGrid').innerHTML=`
    <div class="kpi green">
      <div class="kpi-lbl">Çıkış Debisi Q_b</div>
      <div class="kpi-val">${r.Q_b.toFixed(2)}</div>
      <div class="kpi-unit">L/min — korunur (sıkıştırılamaz)</div>
    </div>
    <div class="kpi ${r.P_out_bar<0?'danger':r.P_out_bar<0.3?'warn':''}">
      <div class="kpi-lbl">Çıkış Basıncı P_b</div>
      <div class="kpi-val">${r.P_out_bar.toFixed(3)}</div>
      <div class="kpi-unit">bar</div>
    </div>
    <div class="kpi warn">
      <div class="kpi-lbl">Toplam ΔP</div>
      <div class="kpi-val">${(r.tot.dP/1e5).toFixed(4)}</div>
      <div class="kpi-unit">bar</div>
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Toplam Yük Kaybı</div>
      <div class="kpi-val">${r.tot.total.toFixed(3)}</div>
      <div class="kpi-unit">m su sütunu</div>
    </div>
  `;

  // Loss breakdown bars
  const lossItems=[
    {label:'Sürtünme (Darcy-Weisbach)', val:r.tot.fr,    color:'#ff6b35'},
    {label:'Bağlantı Elemanları (ΣK)', val:r.tot.fit,   color:'#00e5ff'},
    {label:'Yükseklik Farkı (Δz)',     val:r.tot.elev,  color:r.tot.elev>=0?'#ffdd57':'#23d160'},
    {label:'Çap Geçişleri',            val:r.tot.trans, color:'#bd93f9'},
  ];
  const maxL=Math.max(...lossItems.map(i=>Math.abs(i.val)),0.001);
  el('lossBreakdown').innerHTML=lossItems.map(item=>`
    <div class="loss-row">
      <div class="loss-meta">
        <span class="lname">${item.label}</span>
        <span class="lval" style="color:${item.color}">${item.val>=0?'+':''}${item.val.toFixed(4)} m</span>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.abs(item.val)/maxL*100}%;background:${item.color}"></div></div>
    </div>
  `).join('');

  // Flow diagram
  renderDiagram(r);

  // Table
  const th=`<tr>
    <th>#</th><th>D mm</th><th>L m</th><th>Δz m</th>
    <th>v m/s</th><th>Re</th><th>Rejim</th><th>f</th>
    <th>h_fr m</th><th>h_fit m</th><th>h_z m</th><th>h_trans m</th>
    <th>ΔH m</th><th>ΔP bar</th>
  </tr>`;
  const tb=r.segments.map((s,i)=>`<tr>
    <td class="mono">${i+1}</td>
    <td class="mono">${s.diameter_mm}</td>
    <td class="mono">${s.length_m}</td>
    <td class="mono">${s.dz_m}</td>
    <td class="mono">${s.v.toFixed(3)}</td>
    <td class="mono">${Math.round(s.Re).toLocaleString()}</td>
    <td class="mono c-${s.regime.code}">${s.regime.regime}</td>
    <td class="mono" style="font-size:10px">${s.f.toFixed(6)}</td>
    <td class="mono">${s.hf.friction.toFixed(4)}</td>
    <td class="mono">${s.hf.fittings.toFixed(4)}</td>
    <td class="mono">${s.hf.elevation.toFixed(4)}</td>
    <td class="mono">${s.hf.transition.toFixed(4)}</td>
    <td class="mono c-warn">${s.hf.total.toFixed(4)}</td>
    <td class="mono c-ok">${s.dP_bar.toFixed(5)}</td>
  </tr>`).join('');
  el('segTable').innerHTML=`<div class="tbl-wrap"><table><thead>${th}</thead><tbody>${tb}</tbody></table></div>`;

  // Charts
  renderCharts(r);

  el('results').scrollIntoView({behavior:'smooth', block:'start'});
}

// ─────────────────────────────────────────────────────────────────────
// 10. FLOW DIAGRAM SVG
// ─────────────────────────────────────────────────────────────────────
function renderDiagram(r){
  const segs=r.segments;
  const n=segs.length;
  const bW=130, bH=52, gap=55;
  const W=n*(bW+gap)+120;
  const H=160, cy=H/2;
  const sx=50;

  let svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" style="font-family:'Space Mono',monospace">
    <defs>
      <marker id="arr" markerWidth="8" markerHeight="8" refX="6" refY="3" orient="auto">
        <path d="M0,0 L0,6 L8,3 z" fill="#00e5ff"/>
      </marker>
    </defs>`;

  // A label
  svg+=`<text x="4" y="${cy+4}" fill="#00e5ff" font-size="14" font-weight="bold">A</text>`;
  svg+=`<text x="4" y="${cy+16}" fill="#5a7080" font-size="8">${r.Q_lpm.toFixed(1)} L/m</text>`;
  svg+=`<line x1="22" y1="${cy}" x2="${sx-2}" y2="${cy}" stroke="#00e5ff" stroke-width="1.5" marker-end="url(#arr)"/>`;

  // Pressure gradient line (dashed, above)
  const pGrad=[];
  let pAcc=r.P_in_bar;
  segs.forEach((s,i)=>{
    const x=sx+i*(bW+gap);
    pGrad.push([x+bW/2, pAcc]);
    pAcc-=s.dP_bar;
  });
  // normalize to y coords
  const pMax=r.P_in_bar, pMin=Math.min(r.P_out_bar, 0);
  const pRange=pMax-pMin||1;
  const yP=p=>20+(1-(p-pMin)/pRange)*30;
  if(pGrad.length>1){
    const pts=pGrad.map(([x,p])=>`${x},${yP(p)}`).join(' ');
    svg+=`<polyline points="${pts}" fill="none" stroke="rgba(255,107,53,0.4)" stroke-width="1.5" stroke-dasharray="3,2"/>`;
  }

  segs.forEach((s,i)=>{
    const x=sx+i*(bW+gap);
    const col=s.regime.color;
    svg+=`<rect x="${x}" y="${cy-22}" width="${bW}" height="44" fill="#111520" stroke="${col}" stroke-width="1.5" rx="1"/>`;
    svg+=`<text x="${x+bW/2}" y="${cy-8}" fill="${col}" font-size="9" text-anchor="middle" letter-spacing="1">SEG ${i+1}</text>`;
    svg+=`<text x="${x+bW/2}" y="${cy+3}" fill="#c8d8e8" font-size="9" text-anchor="middle">D=${s.diameter_mm}mm  L=${s.length_m}m</text>`;
    svg+=`<text x="${x+bW/2}" y="${cy+14}" fill="#5a7080" font-size="8" text-anchor="middle">Re=${Math.round(s.Re).toLocaleString()}  v=${s.v.toFixed(2)}m/s</text>`;
    if(s.dz_m!==0){
      const c2=s.dz_m>0?'#ffdd57':'#23d160';
      svg+=`<text x="${x+bW/2}" y="${cy-30}" fill="${c2}" font-size="8" text-anchor="middle">Δz=${s.dz_m>0?'+':''}${s.dz_m}m</text>`;
    }
    // Arrow to next
    if(i<n-1){
      const ax=x+bW, ax2=ax+gap;
      svg+=`<line x1="${ax}" y1="${cy}" x2="${ax2-6}" y2="${cy}" stroke="#00e5ff" stroke-width="1.5" stroke-dasharray="4,2" marker-end="url(#arr)"/>`;
      svg+=`<text x="${ax+gap/2}" y="${cy-8}" fill="#ff6b35" font-size="8" text-anchor="middle">-${s.dP_bar.toFixed(3)}b</text>`;
    }
  });

  // B label
  const bx=sx+n*(bW+gap)-gap+bW;
  svg+=`<line x1="${bx}" y1="${cy}" x2="${bx+26}" y2="${cy}" stroke="#00e5ff" stroke-width="1.5" marker-end="url(#arr)"/>`;
  svg+=`<text x="${bx+32}" y="${cy+4}" fill="#39ff14" font-size="14" font-weight="bold">B</text>`;
  svg+=`<text x="${bx+30}" y="${cy+16}" fill="#5a7080" font-size="8">${r.P_out_bar.toFixed(3)} bar</text>`;

  svg+=`</svg>`;
  document.getElementById('diagram').innerHTML=svg;
}

// ─────────────────────────────────────────────────────────────────────
// 11. RESULT CHARTS
// ─────────────────────────────────────────────────────────────────────
function renderCharts(r){
  const labels=r.segments.map((_,i)=>`Seg ${i+1}`);
  const chartOpts={
    responsive:true,
    plugins:{legend:{labels:{color:'#5a7080',font:{family:'Space Mono',size:10}}}},
    scales:{
      x:{ticks:{color:'#5a7080',font:{family:'Space Mono',size:9}}, grid:{color:'rgba(30,42,58,0.8)'}},
      y:{ticks:{color:'#5a7080',font:{family:'Space Mono',size:9}}, grid:{color:'rgba(30,42,58,0.8)'}},
    }
  };

  // Pressure profile
  let pCum=r.P_in_bar;
  const pVals=[];
  r.segments.forEach(s=>{ pCum-=s.dP_bar; pVals.push(+pCum.toFixed(4)); });
  if(chartP) chartP.destroy();
  chartP=new Chart(document.getElementById('chartP'),{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'P çıkış (bar)',
        data:pVals,
        borderColor:'#00e5ff',
        backgroundColor:'rgba(0,229,255,0.07)',
        tension:0.3, pointRadius:4, pointBackgroundColor:'#00e5ff', borderWidth:2,
      }]
    },
    options:chartOpts,
  });

  // Loss components stacked
  if(chartLoss) chartLoss.destroy();
  chartLoss=new Chart(document.getElementById('chartLoss'),{
    type:'bar',
    data:{
      labels,
      datasets:[
        { label:'Sürtünme', data:r.segments.map(s=>+s.hf.friction.toFixed(4)), backgroundColor:'rgba(255,107,53,0.7)' },
        { label:'Bağlantı', data:r.segments.map(s=>+s.hf.fittings.toFixed(4)), backgroundColor:'rgba(0,229,255,0.6)' },
        { label:'Yükseklik',data:r.segments.map(s=>+s.hf.elevation.toFixed(4)),backgroundColor:'rgba(255,221,87,0.6)' },
        { label:'Çap Geçiş',data:r.segments.map(s=>+s.hf.transition.toFixed(4)),backgroundColor:'rgba(189,147,249,0.6)' },
      ]
    },
    options:{...chartOpts, scales:{...chartOpts.scales, x:{...chartOpts.scales.x, stacked:true}, y:{...chartOpts.scales.y, stacked:true}}},
  });
}

// ─────────────────────────────────────────────────────────────────────
// 12. INIT
// ─────────────────────────────────────────────────────────────────────
window.addSegment    = addSegment;
window.removeSegment = removeSegment;
window.resetSegments = resetSegments;
window.runCalc       = runCalc;
window.onInputChange = onInputChange;
window.onRoughChange = onRoughChange;

resetSegments();
onInputChange();
initFluidChart();

</script>
</body>
</html>
