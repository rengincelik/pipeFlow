<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>PipeFlow — Motor Testi</title>
<style>
  body { background:#0d1117; color:#c9d1d9; font-family:'Courier New',monospace; padding:24px; font-size:13px; }
  h1   { color:#58a6ff; margin-bottom:4px; font-size:18px; letter-spacing:2px; }
  p.sub { color:#8b949e; margin-bottom:24px; font-size:11px; }
  .suite { margin-bottom:28px; }
  .suite-title { color:#e3b341; font-size:13px; border-bottom:1px solid #21262d; padding-bottom:6px; margin-bottom:12px; }
  .test { display:flex; gap:10px; align-items:flex-start; margin-bottom:6px; padding:6px 8px; border-radius:4px; }
  .test.pass { background:rgba(35,134,54,0.12); }
  .test.fail { background:rgba(218,54,51,0.15); }
  .test.info { background:rgba(31,111,235,0.10); }
  .badge { font-size:10px; font-weight:bold; padding:2px 7px; border-radius:3px; flex-shrink:0; margin-top:1px; }
  .badge.pass { background:#238636; color:#fff; }
  .badge.fail { background:#da3633; color:#fff; }
  .badge.info { background:#1f6feb; color:#fff; }
  .test-name { color:#c9d1d9; flex:1; }
  .test-detail { color:#8b949e; font-size:11px; margin-left:4px; }
  .val { color:#79c0ff; }
  .exp { color:#7ee787; }
  .err { color:#f85149; }
  .summary { margin-top:20px; padding:12px 16px; border:1px solid #21262d; }
  .summary span.ok  { color:#7ee787; }
  .summary span.bad { color:#f85149; }

  /* Fluid props table */
  table { border-collapse:collapse; margin-top:8px; font-size:12px; }
  th { color:#8b949e; padding:4px 12px 4px 0; text-align:left; border-bottom:1px solid #21262d; }
  td { padding:3px 12px 3px 0; }
  td.num { color:#79c0ff; text-align:right; padding-right:4px; }
  td.unit { color:#8b949e; font-size:10px; }
</style>
</head>
<body>

<h1>⚙ PIPEFLOW — ENGINE TEST</h1>
<p class="sub">Motor katmanını UI'siz doğrular. Konsol detayları için F12.</p>

<div id="output"></div>

<script type="module">
import { loadFluid }  from './engine/fluidLoader.js';
import { calcSystem, frictionFactor, reynoldsNumber, flowRegime } from './engine/hydraulics.js';

// ── TEST ALTYAPISI ─────────────────────────────────────────
const results = [];

function assert(name, condition, detail = '') {
  results.push({ name, pass: condition, detail, type: 'assert' });
  console[condition ? 'log' : 'error'](`[${condition ? 'PASS' : 'FAIL'}] ${name}`, detail);
}

function approxEqual(a, b, tol = 0.02) {
  // %2 tolerans (mühendislik hassasiyeti)
  return Math.abs(a - b) / (Math.abs(b) || 1) < tol;
}

function info(name, detail) {
  results.push({ name, pass: null, detail, type: 'info' });
  console.info(`[INFO] ${name}:`, detail);
}

// ── TEST SÜİTLERİ ─────────────────────────────────────────

async function runTests() {

  // ─────────────────────────────────────────────────────────
  // SUITE 1: Fluid Loader
  // ─────────────────────────────────────────────────────────
  startSuite('1 — Fluid Loader & Interpolasyon');

  let water;
  try {
    water = await loadFluid('./fluids/water.json', './fluids/water_props.csv');
    assert('Su yüklendi', !!water, water?.name);
    assert('FluidModel adı doğru', water.name === 'Su (H₂O)', water.name);
  } catch (e) {
    assert('Fluid yükleme', false, e.message);
    renderResults();
    return;
  }

  // 20°C — referans noktası (NIST: ρ=998.2, μ=1.002 mPa·s)
  const p20 = water.getProps(20);
  info('Su 20°C kaynağı', p20.source);
  assert('ρ(20°C) ≈ 998.2 kg/m³',  approxEqual(p20.rho, 998.2, 0.005), `hesap=${p20.rho.toFixed(2)}, beklenen=998.2`);
  assert('μ(20°C) ≈ 1.002 mPa·s',  approxEqual(p20.mu,  1.002, 0.02),  `hesap=${p20.mu.toFixed(4)}, beklenen=1.002`);
  assert('ν(20°C) ≈ 1.004 mm²/s',  approxEqual(p20.nu,  1.004, 0.02),  `hesap=${p20.nu.toFixed(4)}, beklenen=1.004`);

  // 80°C — interpolasyon testi (NIST: ρ=971.8, μ=0.355 mPa·s)
  const p80 = water.getProps(80);
  assert('ρ(80°C) ≈ 971.8 kg/m³',  approxEqual(p80.rho, 971.8, 0.01), `hesap=${p80.rho.toFixed(2)}, beklenen=971.8`);
  assert('μ(80°C) ≈ 0.355 mPa·s',  approxEqual(p80.mu,  0.355, 0.03), `hesap=${p80.mu.toFixed(4)}, beklenen=0.355`);

  // 50°C — ara nokta (NIST: ρ=988.1, μ=0.547 mPa·s)
  const p50 = water.getProps(50);
  assert('ρ(50°C) ≈ 988.1 kg/m³',  approxEqual(p50.rho, 988.1, 0.01), `hesap=${p50.rho.toFixed(2)}, beklenen=988.1`);
  assert('μ(50°C) ≈ 0.547 mPa·s',  approxEqual(p50.mu,  0.547, 0.03), `hesap=${p50.mu.toFixed(4)}, beklenen=0.547`);

  // Sınır dışı uyarı testi
  const pOut = water.getProps(160);
  assert('T=160°C uyarı verir', pOut.warnings.length > 0, pOut.warnings[0]);

  // Tablo göster
  renderFluidTable(water, [0, 20, 40, 60, 80, 100, 120]);

  // ─────────────────────────────────────────────────────────
  // SUITE 2: Sürtünme Faktörü
  // ─────────────────────────────────────────────────────────
  startSuite('2 — Darcy Sürtünme Faktörü');

  // Laminer: f = 64/Re
  const f_lam = frictionFactor(1000, 0.05, 0.046);
  assert('Laminer f = 64/Re',
    approxEqual(f_lam, 64/1000, 0.001),
    `f=${f_lam.toFixed(6)}, 64/Re=${(64/1000).toFixed(6)}`);

  // Türbülanslı: Moody chart değerleriyle kıyasla
  // D=100mm, ε=0.046mm → ε/D=0.00046, Re=100000 → f≈0.0208 (Moody)
  const f_turb = frictionFactor(100000, 0.1, 0.046);
  assert('Türbülanslı f (Re=1e5, ε/D=4.6e-4) ≈ 0.0208',
    approxEqual(f_turb, 0.0208, 0.03),
    `f=${f_turb.toFixed(5)}, beklenen≈0.0208`);

  // Pürüzsüz boru, yüksek Re: Blasius f ≈ 0.316*Re^-0.25
  const Re_b = 50000;
  const f_blasius = 0.316 * Math.pow(Re_b, -0.25);
  const f_smooth  = frictionFactor(Re_b, 0.05, 0.001); // çok pürüzsüz
  assert(`Pürüzsüz boru f ≈ Blasius (Re=${Re_b})`,
    approxEqual(f_smooth, f_blasius, 0.05),
    `f=${f_smooth.toFixed(5)}, Blasius=${f_blasius.toFixed(5)}`);

  // Geçiş bölgesi interpolasyon
  const f_tr = frictionFactor(3150, 0.05, 0.046);
  assert('Geçiş Re=3150 → f laminer ve türbülanslı arasında',
    f_tr > 64/4000 && f_tr < 64/2300,
    `f=${f_tr.toFixed(5)}`);

  // ─────────────────────────────────────────────────────────
  // SUITE 3: Sistem Hesabı — Referans Örnek
  // ─────────────────────────────────────────────────────────
  startSuite('3 — Sistem Hesabı (Referans)');

  /*
   * El hesabı doğrulama:
   * Su @ 20°C: ρ=998.2 kg/m³, μ=1.002 mPa·s, ν=1.004e-6 m²/s
   * D = 50 mm = 0.05 m   →   A = π*0.05²/4 = 1.9635e-3 m²
   * Q = 50 L/min = 8.333e-4 m³/s
   * v = Q/A = 0.4244 m/s
   * Re = v*D/ν = 0.4244*0.05/1.004e-6 = 21,133  → Türbülanslı
   * f (Colebrook, ε=0.046mm, ε/D=9.2e-4) ≈ 0.02896
   * hf = f*(L/D)*(v²/2g) = 0.02896*(10/0.05)*(0.4244²/19.613) = 0.02896*200*0.00917 = 0.05318 m
   * ΔP = ρgΔH = 998.2*9.807*0.05318 = 520 Pa ≈ 0.0052 bar
   */
  const FITTING_K = { elbow90: 0.75, elbow45: 0.35, gate: 0.2, globe: 6.0, ball: 0.1, check: 2.5 };

  const seg1 = {
    length_m: 10, diameter_mm: 50, dz_m: 0,
    fittings: {}, fittingKValues: FITTING_K, epsilon_mm: 0.046,
  };

  const sys1 = calcSystem([seg1], 50, 2.0, p20);
  info('El hesabı referans (D=50mm, L=10m, Q=50lpm, T=20°C)', '');
  info('v hesaplanan', sys1.segments[0].v_ms + ' m/s (beklenen≈0.4244)');
  info('Re hesaplanan', sys1.segments[0].Re + ' (beklenen≈21133)');
  info('f  hesaplanan', sys1.segments[0].f  + ' (beklenen≈0.0290)');
  info('hf hesaplanan', sys1.segments[0].hf_friction + ' m (beklenen≈0.053)');

  assert('v ≈ 0.424 m/s', approxEqual(sys1.segments[0].v_ms, 0.4244, 0.01), `v=${sys1.segments[0].v_ms}`);
  assert('Re ≈ 21133',    approxEqual(sys1.segments[0].Re,   21133,  0.02), `Re=${sys1.segments[0].Re}`);
  assert('Rejim Türbülanslı', sys1.segments[0].regime === 'Türbülanslı', sys1.segments[0].regime);
  assert('hf_friction ≈ 0.053 m', approxEqual(sys1.segments[0].hf_friction, 0.0532, 0.05),
         `hf=${sys1.segments[0].hf_friction}`);
  assert('Q korunur', sys1.Q_in_lpm === sys1.Q_out_lpm, `in=${sys1.Q_in_lpm}, out=${sys1.Q_out_lpm}`);
  assert('P_out < P_in', sys1.P_out_bar < sys1.P_in_bar, `Pout=${sys1.P_out_bar}`);

  // ─────────────────────────────────────────────────────────
  // SUITE 4: Fitting & Çap Geçişi
  // ─────────────────────────────────────────────────────────
  startSuite('4 — Fitting Kayıpları & Çap Geçişi');

  const segA = {
    length_m: 5, diameter_mm: 50, dz_m: 0,
    fittings: { elbow90: 2, gate: 1 }, fittingKValues: FITTING_K, epsilon_mm: 0.046,
  };
  // K toplam = 2*0.75 + 0.2 = 1.7
  // hm = 1.7 * v²/(2g) = 1.7 * 0.4244²/19.613 = 0.01560 m
  const sysA = calcSystem([segA], 50, 2.0, p20);
  assert('K_total = 1.7', approxEqual(sysA.segments[0].K_total, 1.7, 0.001),
         `K=${sysA.segments[0].K_total}`);
  assert('hf_fittings ≈ 0.0156 m', approxEqual(sysA.segments[0].hf_fittings, 0.0156, 0.05),
         `hf_fit=${sysA.segments[0].hf_fittings}`);

  // Yükseklik: Q=50lpm, D=50mm, dz=+3m → hf_elevation=3
  const segB = { length_m: 1, diameter_mm: 50, dz_m: 3, fittings: {}, fittingKValues: FITTING_K, epsilon_mm: 0.046 };
  const sysB = calcSystem([segB], 50, 5.0, p20);
  assert('Yükseklik kaybı = dz = 3 m', approxEqual(sysB.segments[0].hf_elevation, 3.0, 0.001),
         `hel=${sysB.segments[0].hf_elevation}`);

  // Çap daralması 50→25mm: genişleme kaybı olmamalı, daralma kaybı olmalı
  const seg50 = { length_m: 2, diameter_mm: 50, dz_m: 0, fittings: {}, fittingKValues: FITTING_K, epsilon_mm: 0.046 };
  const seg25 = { length_m: 2, diameter_mm: 25, dz_m: 0, fittings: {}, fittingKValues: FITTING_K, epsilon_mm: 0.046 };
  const sysC  = calcSystem([seg50, seg25], 50, 3.0, p20);
  assert('Daralma geçiş kaybı > 0', sysC.segments[1].hf_transition > 0,
         `htr=${sysC.segments[1].hf_transition}`);
  assert('Genişleme yok (seg1)', sysC.segments[0].hf_transition === 0,
         `htr_seg1=${sysC.segments[0].hf_transition}`);

  // ─────────────────────────────────────────────────────────
  // SUITE 5: Sıcaklık Etkisi
  // ─────────────────────────────────────────────────────────
  startSuite('5 — Sıcaklık Etkisi');

  const p5   = water.getProps(5);
  const p100 = water.getProps(100);

  // Soğuk suda viskozite > sıcak su
  assert('μ(5°C) > μ(50°C)', p5.mu > p50.mu, `μ5=${p5.mu.toFixed(3)}, μ50=${p50.mu.toFixed(3)}`);
  assert('μ(50°C) > μ(100°C)', p50.mu > p100.mu, `μ50=${p50.mu.toFixed(3)}, μ100=${p100.mu.toFixed(3)}`);

  // Soğuk suda Re düşer → aynı debi için daha yüksek sürtünme
  const sysHot  = calcSystem([{ ...seg1, length_m: 10 }], 50, 2.0, p80);
  const sysCold = calcSystem([{ ...seg1, length_m: 10 }], 50, 2.0, p20);
  assert('Sıcak su < daha az yük kaybı (düşük viskozite)',
    sysHot.totalHL < sysCold.totalHL,
    `hot=${sysHot.totalHL.toFixed(4)}m, cold=${sysCold.totalHL.toFixed(4)}m`);

  // ─────────────────────────────────────────────────────────
  renderResults();
}

// ── RENDER ─────────────────────────────────────────────────
const suites = [];
let currentSuite = null;

function startSuite(title) {
  currentSuite = { title, tests: [] };
  suites.push(currentSuite);
}

// Override results.push to route to suite
const origPush = results.push.bind(results);
results.push = function(item) {
  origPush(item);
  if (currentSuite) currentSuite.tests.push(item);
};

function renderFluidTable(fluid, temps) {
  const rows = temps.map(T => {
    const p = fluid.getProps(T);
    return `<tr>
      <td>${T}</td>
      <td class="num">${p.rho.toFixed(2)}</td><td class="unit">kg/m³</td>
      <td class="num">${p.mu.toFixed(4)}</td><td class="unit">mPa·s</td>
      <td class="num">${p.nu.toFixed(4)}</td><td class="unit">mm²/s</td>
    </tr>`;
  }).join('');
  const html = `
    <div style="margin:8px 0 12px 0">
    <table>
      <thead><tr>
        <th>T (°C)</th><th colspan="2">ρ</th><th colspan="2">μ</th><th colspan="2">ν</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
    </div>`;
  currentSuite.tableHTML = html;
}

function renderResults() {
  const out = document.getElementById('output');
  let pass = 0, fail = 0;

  const suiteHTML = suites.map(s => {
    const testsHTML = s.tests.map(t => {
      if (t.type === 'info') {
        return `<div class="test info">
          <span class="badge info">INF</span>
          <span class="test-name">${t.name}</span>
          <span class="test-detail">${t.detail}</span>
        </div>`;
      }
      if (t.pass) pass++; else fail++;
      return `<div class="test ${t.pass ? 'pass' : 'fail'}">
        <span class="badge ${t.pass ? 'pass' : 'fail'}">${t.pass ? 'PASS' : 'FAIL'}</span>
        <span class="test-name">${t.name}</span>
        <span class="test-detail">${t.detail}</span>
      </div>`;
    }).join('');
    return `<div class="suite">
      <div class="suite-title">${s.title}</div>
      ${s.tableHTML || ''}
      ${testsHTML}
    </div>`;
  }).join('');

  const total = pass + fail;
  out.innerHTML = suiteHTML + `
    <div class="summary">
      <span class="ok">✓ ${pass} geçti</span> &nbsp;|&nbsp;
      <span class="bad">✗ ${fail} başarısız</span> &nbsp;|&nbsp;
      ${total} toplam test
    </div>`;
}

runTests().catch(e => {
  document.getElementById('output').innerHTML =
    `<div style="color:#f85149">HATA: ${e.message}<br><pre>${e.stack}</pre></div>`;
  console.error(e);
});
</script>
</body>
</html>
